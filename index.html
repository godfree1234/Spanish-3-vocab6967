<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spanish Vocab Practice</title>
  <style>
    :root {
      --bg: #071029;
      --card: #0f1630;
      --muted: #9fb0e6;
      --ink: #eaf0ff;
      --accent: #6ea8ff;
      --good: #40d77e;
      --bad: #ff6b6b;
      --glass: rgba(255,255,255,0.04);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color: var(--ink); background: linear-gradient(180deg, #071029 0%, #071029 40%, #041225 100%); display: grid; place-items: center; padding: 28px; }
    .app { width: min(980px, 96vw); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: 18px; padding: 22px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 18px 60px rgba(2,6,23,0.6); }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 14px; }
    h1 { margin: 0; font-size: 20px; }
    .subtitle { color: var(--muted); font-size: 13px; }
    .card { background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.04); display: grid; gap: 14px; }
    .row { display: flex; gap: 12px; align-items: center; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { background: var(--glass); padding: 8px 12px; border-radius: 999px; font-size: 13px; color: var(--muted); border: 1px solid rgba(255,255,255,0.03); }
    .prompt-wrap { display: grid; gap: 6px; align-items: center; }
    .dir { color: var(--muted); font-size: 13px; text-align: center; }
    .prompt { font-size: 24px; font-weight: 600; text-align: center; }
    .answer-area { display: flex; align-items: center; gap: 10px; }
    input[type=text] { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.25); font-size: 18px; color: var(--ink); outline: none; text-align: center; }
    .btnrow { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    button { background: var(--accent); color: #041225; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 6px 18px rgba(110,168,255,0.14); transition: transform .12s ease; }
    button.secondary { background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.04); }
    button.ghost { background: transparent; color: var(--muted); border: 1px dashed rgba(255,255,255,0.04); }
    button:active { transform: translateY(1px); }
    .feedback { min-height: 36px; text-align: center; font-weight: 600; }
    .ok { color: var(--good); }
    .no { color: var(--bad); }
    .hint { color: var(--muted); font-weight: 500; }
    .footer { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .admin-panel { display: none; background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.04); margin-top: 14px; }
    .admin-panel.show { display: block; }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 5px; color: var(--ink); }
    textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.25); color: var(--ink); resize: vertical; }
    select { padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.25); color: var(--ink); }
    input[type=password] { padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.25); color: var(--ink); }
    .small { font-size: 13px; color: var(--muted); }
    @media (max-width: 700px) { .prompt { font-size: 20px; } input[type=text] { font-size: 16px; padding: 12px; } }
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>Spanish Vocab Practice</h1>
        <div class="subtitle">Select a chapter and press Start. Admin for adding vocab (password protected).</div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <select id="chapterSelect" class="pill" style="background: var(--glass); border: 1px solid rgba(255,255,255,0.03); color: var(--muted);">
          <!-- Chapters will be populated by JS -->
        </select>
        <button id="adminBtn" class="secondary">Admin</button>
      </div>
    </header>

    <main class="card" id="card">
      <div class="row" style="justify-content:center">
        <div class="pill" id="progressPill">0 / 0</div>
        <div class="pill" id="streakPill">Streak: 0</div>
      </div>

      <div class="prompt-wrap">
        <div class="dir" id="direction">Select chapter and press Start</div>
        <div class="prompt" id="prompt">—</div>
      </div>

      <div class="answer-area">
        <input id="answer" type="text" placeholder="Type your answer (press Enter)" autocomplete="off" />
      </div>

      <div class="btnrow">
        <button id="checkBtn">Check (Enter)</button>
        <button id="idkBtn" class="secondary">I don't know</button>
        <button id="showBtn" class="ghost">Show answer</button>
        <button id="stopBtn" class="secondary">Stop showing</button>
        <button id="skipBtn" class="secondary">Next</button>
        <button id="startBtn">Start</button>
      </div>

      <div class="feedback" id="feedback"></div>

      <div class="footer" style="margin-top:6px">
        <div class="subtitle">Tip: Arrow → moves to next (unless the answer is locked).</div>
        <div style="display:flex;gap:8px"><div class="pill">Random direction</div></div>
      </div>

      <div class="admin-panel" id="adminPanel" aria-hidden="true">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="small">Admin: default password is <strong>admin</strong>. Change it below.</div>
          <button id="closeAdmin" class="secondary">Close</button>
        </div>

        <div class="form-group">
          <label>Select or type chapter name</label>
          <div style="display:flex;gap:8px;align-items:flex-start">
            <input id="adminChapter" type="text" placeholder="e.g. Chapter 4" style="flex:1" />
            <button id="removeChapterBtn" class="secondary" style="white-space:nowrap">Remove Chapter</button>
          </div>
        </div>

        <div class="form-group" style="display:flex;gap:8px">
          <div style="flex:1">
            <label>Spanish (term)</label>
            <input id="adminEs" type="text" placeholder="Spanish term" />
          </div>
          <div style="flex:1">
            <label>English (definition)</label>
            <input id="adminEn" type="text" placeholder="English translation" />
          </div>
        </div>

        <div class="form-group" style="display:flex;gap:8px;align-items:center">
          <input id="adminPassword" type="password" placeholder="admin password" />
          <button id="addVocabBtn">Add vocab</button>
        </div>

        <hr />

        <div class="form-group">
          <label>Paste Quizlet text here (tab separated or alternating lines)</label>
          <textarea id="quizletText" rows="6" placeholder="term[TAB]definition\nor\nterm\ndefinition\nterm\ndefinition"></textarea>
        </div>
        <div class="form-group" style="display:flex;gap:8px;align-items:center">
          <input id="quizletPassword" type="password" placeholder="admin password" />
          <button id="importQuizletBtn">Import Quizlet</button>
        </div>

        <hr />

        <!-- GitHub Gist sync: publish and sync chapters -->
        <div class="form-group">
          <label>Cloud sync (GitHub Gist) — publish / sync chapters</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="gistId" type="text" placeholder="Gist ID (leave blank to create)" style="flex:1" />
            <input id="githubToken" type="password" placeholder="GitHub token (optional)" style="flex:1" />
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="cloudSyncPassword" type="password" placeholder="Admin password" style="flex:1" />
          </div>
          <div class="small" style="margin-top:6px;color:var(--muted)">
            To publish or update a gist you can provide a GitHub token (gist scope). If you leave it blank the app will attempt unauthenticated requests (rate-limited) — note: updating an existing gist requires a token from the owner. Token is stored in your browser localStorage if used.
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="publishGistBtn">Publish to Gist</button>
            <button id="createGistBtn" class="secondary">Create new gist</button>
            <button id="syncGistBtn" class="secondary">Sync from Gist</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <label style="margin:0"><input id="autoSync" type="checkbox" /> Auto-sync (merge) from gist every</label>
            <input id="autoSyncInterval" type="number" min="10" value="60" style="width:80px" />
            <div class="small">seconds</div>
            <label style="margin-left:12px"><input id="autoPublish" type="checkbox" /> Auto-publish on change (requires token)</label>
          </div>
        </div>

        <hr />
        <div class="form-group" style="display:flex;gap:8px;align-items:center">
          <input id="curPassword" type="password" placeholder="current password" />
          <input id="newPassword" type="password" placeholder="new password" />
          <button id="changePasswordBtn" class="secondary">Change password</button>
        </div>

        <div id="adminMsg" class="small" style="margin-top:8px;color:var(--muted)"></div>
      </div>

    </main>
  </div>

  <script>
    // --- initial chapters collected from existing files ---
    const initialChapters = {
      "Chapter 2": [
        {es:"Pues ven.", en:"So come on."},
        {es:"Vamos, anímate.", en:"Come on. Cheer up."},
        {es:"Arrancar", en:"To go / to start (a race / a car)"},
        {es:"Atreverse", en:"To dare"},
        {es:"La carrera", en:"Race"},
        {es:"Deber", en:"To owe"},
        {es:"Doler", en:"To hurt"},
        {es:"Hacer trampa", en:"To cheat"},
        {es:"Retar", en:"To challenge"},
        {es:"El truco", en:"Trick"},
        {es:"El ajedrez", en:"Chess"},
        {es:"El billar", en:"Pool / billiards"},
        {es:"El boliche", en:"Bowling"},
        {es:"Las cartas", en:"Playing cards"},
        {es:"Los naipes", en:"Playing cards"},
        {es:"El juego de mesa", en:"Board game"},
        {es:"El pasatiempo", en:"Pastime"},
        {es:"La televisión", en:"Television"},
        {es:"El tiempo libre", en:"Free time"},
        {es:"Los ratos libres", en:"Free time"},
        {es:"El videojuego", en:"Video game"},
        {es:"Aburrirse", en:"To get bored"},
        {es:"Alquilar una película", en:"To rent a movie"},
        {es:"Brindar", en:"To make a toast"},
        {es:"Celebrar", en:"To celebrate"},
        {es:"Festejar", en:"To celebrate"},
        {es:"Dar un paseo", en:"To take a stroll / walk"},
        {es:"Disfrutar de", en:"To enjoy"},
        {es:"Divertirse", en:"To have fun"},
        {es:"Entretener", en:"To entertain / to amuse"},
        {es:"Entretenerse", en:"To entertain / to amuse"},
        {es:"Gustar", en:"To like"},
        {es:"Reunirse con", en:"To get together with"},
        {es:"Salir a comer", en:"To go out to eat"},
        {es:"Aficionado", en:"Fond of / a fan of"},
        {es:"Divertido", en:"Fun"},
        {es:"Entretenido", en:"Entertaining"},
        {es:"El cine", en:"Movie theater / cinema"},
        {es:"El circo", en:"Circus"},
        {es:"La discoteca", en:"Discotheque / dance club"},
        {es:"La feria", en:"Fair"},
        {es:"El festival", en:"Festival"},
        {es:"El parque de atracciones", en:"Amusement park"},
        {es:"El zoológico", en:"Zoo"},
        {es:"El árbitro / la árbitra", en:"Referee"},
        {es:"El campeón / la campeona", en:"Champion"},
        {es:"El campeonato", en:"Championship"},
        {es:"El club deportivo", en:"Sports club"},
        {es:"El deportista / la deportista", en:"Athlete"},
        {es:"El empate", en:"Tie game"},
        {es:"El entrenador / la entrenadora", en:"Coach / trainer"},
        {es:"El equipo", en:"Team"},
        {es:"El espectador / la espectadora", en:"Spectator"},
        {es:"El torneo", en:"Tournament"},
        {es:"Anotar / marcar un gol", en:"To score a goal"},
        {es:"Anotar / marcar un punto", en:"To score a point"},
        {es:"Desafiar", en:"To challenge"},
        {es:"Empatar", en:"To tie (game)"},
        {es:"Ganar un partido", en:"To win a game"},
        {es:"Perder un partido", en:"To lose a game"},
        {es:"Vencer", en:"To defeat"},
        {es:"El álbum", en:"Album"},
        {es:"El asiento", en:"Seat"},
        {es:"El cantante / la cantante", en:"Singer"},
        {es:"El concierto", en:"Concert"},
        {es:"El conjunto", en:"Musical group / band"},
        {es:"El grupo musical", en:"Musical group / band"},
        {es:"El escenario", en:"Scenery / stage"},
        {es:"El espectáculo", en:"Show"},
        {es:"El estreno", en:"Premiere / debut"},
        {es:"La función", en:"Performance (theater / movie)"},
        {es:"El músico / la música", en:"Musician"},
        {es:"La obra de teatro", en:"Play"},
        {es:"La taquilla", en:"Box office"},
        {es:"Aplaudir", en:"To applaud"},
        {es:"Conseguir boletos", en:"To get tickets"},
        {es:"Conseguir entradas", en:"To get tickets"},
        {es:"Hacer cola", en:"To wait in line"},
        {es:"Poner un disco compacto", en:"To play a CD"},
        {es:"La aceituna", en:"Olive"},
        {es:"El familiar", en:"Relative"},
        {es:"El ganador / la ganadora", en:"Winner"},
        {es:"El gorro de lana", en:"Wool cap"},
        {es:"El pejerrey", en:"Kingfish"},
        {es:"El pique", en:"Bite"},
        {es:"El precinto", en:"Security seal"},
        {es:"La rodaja", en:"Slice"},
        {es:"El señuelo", en:"Lure"},
        {es:"El testimonio de defunción", en:"Death certificate"},
        {es:"La ventaja", en:"Advantage"},
        {es:"Envolver", en:"To wrap"},
        {es:"Hundir", en:"To sink"},
        {es:"Tejer", en:"To knit"},
        {es:"La imagen", en:"Image / picture"},
        {es:"La pantalla", en:"Screen"},
        {es:"El televisor", en:"TV set"},
        {es:"Colocar", en:"To place"},
        {es:"Señalar", en:"To point at"},
        {es:"Hondo", en:"Deep"},
        {es:"Redondo", en:"Round"},
        {es:"Por primera vez", en:"For the first time"},
        {es:"Por última vez", en:"For the last time"},
        {es:"La corrida", en:"Bullfight"},
        {es:"El matador / la matadora", en:"Bullfighter"},
        {es:"La plaza de toros", en:"Bullfighting stadium / arena"},
        {es:"El ruedo", en:"Bullring"},
        {es:"El toreo", en:"Bullfighting"},
        {es:"El torero / la torera", en:"Bullfighter"},
        {es:"El traje de luces", en:"Bullfighter's outfit"},
        {es:"Lidiar", en:"To fight (bulls)"},
        {es:"Torear", en:"To fight bulls"}
      ],
      "Chapter 3": [{"es": "¡Una ganga!", "en": "A bargain!"}, {"es": "Arruinar", "en": "To ruin"}, {"es": "La artesanía", "en": "Handicraft"}, {"es": "La broma", "en": "Joke"}, {"es": "La disculpa", "en": "Apology"}, {"es": "Humilde", "en": "Humble"}, {"es": "Pálido", "en": "Pale"}, {"es": "Retrasarse", "en": "To be delayed / to be late"}, {"es": "El balcón", "en": "Balcony"}, {"es": "La escalera", "en": "Staircase"}, {"es": "El hogar", "en": "Home / fireplace"}, {"es": "La limpieza", "en": "Cleaning"}, {"es": "Los muebles", "en": "Furniture"}, {"es": "Los quehaceres", "en": "Chores"}, {"es": "Apagar", "en": "To turn off"}, {"es": "Barrer", "en": "To sweep"}, {"es": "Calentar (e-ie)", "en": "To warm up"}, {"es": "Cocinar", "en": "To cook"}, {"es": "Encender (e-ie)", "en": "To turn on"}, {"es": "Freír (e-i)", "en": "To fry"}, {"es": "Hervir", "en": "To boil"}, {"es": "Lavar", "en": "To wash"}, {"es": "Limpiar", "en": "To clean"}, {"es": "Pasar la aspiradora", "en": "To vacuum"}, {"es": "Poner la mesa", "en": "To set the table"}, {"es": "Quitar la mesa", "en": "To clear the table"}, {"es": "Quitar el polvo", "en": "To dust"}, {"es": "Tocar el timbre", "en": "To ring the doorbell"}, {"es": "El centro comercial", "en": "Mall"}, {"es": "El dinero en efectivo", "en": "Cash"}, {"es": "La ganga", "en": "Bargain"}, {"es": "El probador", "en": "Dressing room"}, {"es": "El reembolso", "en": "Refund"}, {"es": "El supermercado", "en": "Supermarket"}, {"es": "La tarjeta de crédito", "en": "Credit card"}, {"es": "La tarjeta de débito", "en": "Debit card"}, {"es": "Devolver (o-ue)", "en": "To return (items)"}, {"es": "Hacer mandados", "en": "To run errands"}, {"es": "Ir de compras", "en": "To go shopping"}, {"es": "Probarse (o-ue)", "en": "To try on"}, {"es": "Seleccionar", "en": "To select / to pick out"}, {"es": "Auténtico", "en": "Authentic"}, {"es": "Barato", "en": "Cheap"}, {"es": "Caro", "en": "Expensive"}, {"es": "A menudo", "en": "Often"}, {"es": "A propósito", "en": "On purpose"}, {"es": "A tiempo", "en": "On time"}, {"es": "A veces", "en": "Sometimes"}, {"es": "Apenas", "en": "Hardly"}, {"es": "Así", "en": "Like this / so"}, {"es": "Bastante", "en": "Quite / enough"}, {"es": "Casi", "en": "Almost"}, {"es": "Casi nunca", "en": "Rarely"}, {"es": "De repente", "en": "Suddenly"}, {"es": "De vez en cuando", "en": "Once in a while"}, {"es": "En aquel entonces", "en": "At that time"}, {"es": "En el acto", "en": "Immediately"}, {"es": "Enseguida", "en": "Right away"}, {"es": "Por casualidad", "en": "By chance"}, {"es": "La agenda", "en": "Agenda"}, {"es": "La costumbre", "en": "Custom / habit"}, {"es": "El horario", "en": "Schedule"}, {"es": "La rutina", "en": "Routine"}, {"es": "La soledad", "en": "Loneliness"}, {"es": "Acostumbrarse a", "en": "To get used to"}, {"es": "Arreglarse", "en": "To get ready"}, {"es": "Averiguar", "en": "To find out"}, {"es": "Probar (o-ue) a", "en": "To try"}, {"es": "Soler (o-ue)", "en": "To be in the habit of"}, {"es": "Atrasado", "en": "Late"}, {"es": "Cotidiana", "en": "Everyday"}, {"es": "Diario", "en": "Daily"}, {"es": "Inesperado", "en": "Unexpected"}, {"es": "La cinta", "en": "Tape"}, {"es": "La luz", "en": "Light"}, {"es": "Alargar", "en": "To drag out"}, {"es": "Enterarse", "en": "To find out"}, {"es": "Entretenerse", "en": "To be held up"}, {"es": "Respirar", "en": "To breathe"}, {"es": "Pesado", "en": "Annoying"}, {"es": "Precioso", "en": "Lovely"}, {"es": "Turbio", "en": "Murky"}, {"es": "A lo mejor", "en": "Maybe"}, {"es": "El autorretrato", "en": "Self-portrait"}, {"es": "El maquillaje", "en": "Make-up"}, {"es": "El llanto", "en": "Crying"}, {"es": "Acariciar", "en": "To caress"}, {"es": "Llorar", "en": "To cry"}, {"es": "Lucir", "en": "To wear / to display"}, {"es": "Arduo", "en": "Hard"}, {"es": "Feliz", "en": "Happy"}, {"es": "Acaso", "en": "Perhaps"}, {"es": "El cansancio", "en": "Exhaustion"}, {"es": "El cuadro", "en": "Painting"}, {"es": "La obra maestra", "en": "Masterpiece"}, {"es": "El pintor / la pintora", "en": "Painter"}, {"es": "El retrato", "en": "Portrait"}, {"es": "Pintar", "en": "To paint"}, {"es": "Retratar", "en": "To portray"}, {"es": "Fatigado", "en": "Fatigued"}, {"es": "Imprevisto", "en": "Unexpected"}, {"es": "Previsto", "en": "Planned / expected"}],
      "Chapter 4": [
        {'es': 'Es mejor que se quede esta noche en el hospital', 'en': 'It is better that she stay at the hospital overnight.'},
        {'es': 'Es urgente que la establicemos', 'en': "It's urgent that we stabilize her."},
        {'es': '¡Espero que no sea una broma, Manu!', 'en': 'I hope this is not a joke, Manu.'},
        {'es': 'Necesito que estés tranquilo', 'en': 'I need you to stay calm.'},
        {'es': 'Necesito que pises el acelerador y vengas al hospital', 'en': 'I need you to step on the gas and get to the hospital.'},
        {'es': '¡Agárrate!', 'en': 'Hold on!'},
        {'es': '¡Détente!', 'en': 'Stop!'},
        {'es': '¡Espera!', 'en': 'Wait!'},
        {'es': '¡No seas ridícula!', 'en': "Don't be ridiculous!"},
        {'es': 'Relájese y espere acá, por favor', 'en': 'Relax and wait here, please.'},
        {'es': 'Shhh, no hagan ruido por si acaso está durmiendo', 'en': "Shhh, don't make any noise in case she's sleeping."},
        {'es': 'Arreglárselas', 'en': 'To manage to'},
        {'es': 'Detenerse', 'en': 'To stop'},
        {'es': '¡No es para tanto!', 'en': "It's not a big deal!"},
        {'es': '¡Por Dios!', 'en': "For God's sake!"},
        {'es': 'Por lo visto', 'en': 'Apparently'},
        {'es': 'La presión', 'en': '(blood) pressure'},
        {'es': 'La depresión', 'en': 'Depression'},
        {'es': 'La enfermedad', 'en': 'Disease / Illness'},
        {'es': 'La gripe', 'en': 'Flu'},
        {'es': 'La herida', 'en': 'Injury'},
        {'es': 'El malestar', 'en': 'Discomfort'},
        {'es': 'La obesidad', 'en': 'Obesity'},
        {'es': 'El resfriado', 'en': 'Cold'},
        {'es': 'La respiración', 'en': 'Breathing'},
        {'es': 'La tensión alta', 'en': 'High blood pressure'},
        {'es': 'La tensión baja', 'en': 'Low blood pressure'},
        {'es': 'La tos', 'en': 'Cough'},
        {'es': 'El virus', 'en': 'Virus'},
        {'es': 'Contagiarse', 'en': 'To become infected'},
        {'es': 'Desmayarse', 'en': 'To faint'},
        {'es': 'Empeorar', 'en': 'To get worse'},
        {'es': 'Enfermarse', 'en': 'To get sick'},
        {'es': 'Estar resfriado/a', 'en': 'To have a cold'},
        {'es': 'Lastimarse', 'en': 'To get hurt'},
        {'es': 'Permanecer', 'en': 'To remain / to last'},
        {'es': 'Ponerse bien', 'en': 'To get well'},
        {'es': 'Ponerse mal', 'en': 'To get sick'},
        {'es': 'Tener buen aspecto', 'en': 'To look healthy'},
        {'es': 'Tener mal aspecto', 'en': 'To look sick'},
        {'es': 'Toser', 'en': 'To cough'},
        {'es': 'Agotado/a', 'en': 'Exhausted'},
        {'es': 'Inflamado/a', 'en': 'Inflamed'},
        {'es': 'Mareado/a', 'en': 'Dizzy'},
        {'es': 'La alimentación', 'en': 'Diet (nutrition)'},
        {'es': 'La autoestima', 'en': 'Self-esteem'},
        {'es': 'El bienestar', 'en': 'Well-being'},
        {'es': 'El estado de ánimo', 'en': 'Mood'},
        {'es': 'La salud', 'en': 'Health'},
        {'es': 'Adelgazar', 'en': 'To lose weight'},
        {'es': 'Descansar', 'en': 'To rest'},
        {'es': 'Engordar', 'en': 'To gain weight'},
        {'es': 'Estar a dieta', 'en': 'To be on a diet'},
        {'es': 'Mejorar', 'en': 'To improve'},
        {'es': 'Prevenir', 'en': 'To prevent'},
        {'es': 'Relajarse', 'en': 'To relax'},
        {'es': 'Trasnochar', 'en': 'To stay up all night'},
        {'es': 'Sano/a', 'en': 'Healthy'},
        {'es': 'La cirugía', 'en': 'Surgery'},
        {'es': 'El cirujano / la cirujana', 'en': 'Surgeon'},
        {'es': 'La consulta', 'en': "Doctor's appointment"},
        {'es': 'El consultorio', 'en': "Doctor's office"},
        {'es': 'La operación', 'en': 'Operation'},
        {'es': 'Los primeros auxilios', 'en': 'First aid'},
        {'es': 'La sala de emergencias', 'en': 'Emergency room'}]
    
    };

    // --- storage keys and password setup ---
    const STORAGE_KEY = 'svp_chapters_v1';
    const PW_KEY = 'svp_password_b64_v1';
  const DEFAULT_GIST_ID = 'cb04cdeee1231258bb5e0f8e924cc938';

    // default password (obfuscated with base64) — default is '01062010D@nesh'
    if(!localStorage.getItem(PW_KEY)) localStorage.setItem(PW_KEY, btoa('01062010D@nesh'));

    function loadChapters(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){
          // first run: persist the initial chapters into localStorage so stored data
          // becomes authoritative afterwards (adds/removals will persist)
          const copy = JSON.parse(JSON.stringify(initialChapters));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(copy));
          return copy;
        }
        // when stored, parsed object is authoritative
        return JSON.parse(raw);
      }catch(e){
        // fallback to initial chapters if anything goes wrong
        return JSON.parse(JSON.stringify(initialChapters));
      }
    }

    function saveChapters(chapters){
      // always save the full chapters object so subsequent loads are authoritative
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chapters));
    }

    // --- elements ---
    const els = {
      chapterSelect: document.getElementById('chapterSelect'),
      direction: document.getElementById('direction'),
      prompt: document.getElementById('prompt'),
      answer: document.getElementById('answer'),
      feedback: document.getElementById('feedback'),
      progressPill: document.getElementById('progressPill'),
      streakPill: document.getElementById('streakPill'),
      startBtn: document.getElementById('startBtn'),
      checkBtn: document.getElementById('checkBtn'),
      idkBtn: document.getElementById('idkBtn'),
      showBtn: document.getElementById('showBtn'),
      stopBtn: document.getElementById('stopBtn'),
      skipBtn: document.getElementById('skipBtn'),
      adminBtn: document.getElementById('adminBtn'),
      adminPanel: document.getElementById('adminPanel'),
      closeAdmin: document.getElementById('closeAdmin'),
      adminChapter: document.getElementById('adminChapter'),
      adminEs: document.getElementById('adminEs'),
      adminEn: document.getElementById('adminEn'),
      adminPassword: document.getElementById('adminPassword'),
      addVocabBtn: document.getElementById('addVocabBtn'),
      quizletText: document.getElementById('quizletText'),
      quizletPassword: document.getElementById('quizletPassword'),
      importQuizletBtn: document.getElementById('importQuizletBtn'),
  cloudSyncPassword: document.getElementById('cloudSyncPassword'),
      createGistBtn: document.getElementById('createGistBtn'),
      adminMsg: document.getElementById('adminMsg'),
      curPassword: document.getElementById('curPassword'),
      newPassword: document.getElementById('newPassword'),
      changePasswordBtn: document.getElementById('changePasswordBtn')
    };

    // --- state ---
    let chapters = loadChapters();
    let items = [], index = -1, current = null;
    let total = 0, correct = 0, streak = 0;
    let locked = false;

    // --- utilities ---
    function shuffle(a){ const arr = [...a]; for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]} return arr; }

    function normalizeSegment(s){
      if(!s) return '';
      s = String(s).toLowerCase();
      s = s.replace(/\(.*?\)/g, '');
      s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      s = s.replace(/[^a-z0-9ñü\s/]/g, ' ');
      s = s.replace(/\b(to|the|a|an|el|la|los|las|un|una|unos|unas)\b/g, ' ');
      s = s.replace(/\s+/g, ' ').trim();
      return s;
    }

    function isCorrect(input, target){
      const inN = normalizeSegment(input);
      const parts = String(target).split('/').map(p=>normalizeSegment(p)).filter(Boolean);
      if(parts.length===0) return inN === normalizeSegment(target);
      return parts.some(p => p === inN);
    }

    function updatePills(){
      els.progressPill.textContent = items.length ? `${index+1} / ${items.length}` : '0 / 0';
      els.streakPill.textContent = `Streak: ${streak}`;
    }

    function setPrompt(showSpanish){
      if(!current) return;
      els.direction.textContent = showSpanish ? 'Type the English:' : 'Escribe en español:';
      els.prompt.textContent = showSpanish ? current.es : current.en;
      els.answer.dataset.target = showSpanish ? current.en : current.es;
      els.answer.value = '';
      els.answer.focus();
      els.feedback.textContent = '';
      updatePills();
    }

    function next(){ if(locked) return; if(items.length===0){ els.prompt.textContent='No items.'; return; } index=(index+1)%items.length; current = items[index]; const showSpanish = Math.random()<0.5; setPrompt(showSpanish); }

    // --- practice actions ---
    function start(){
      const chap = els.chapterSelect.value;
      if(!chap || !chapters[chap] || chapters[chap].length===0){ els.feedback.textContent='No vocab for this chapter.'; return; }
      items = shuffle(chapters[chap]); index=-1; current=null; total=0; correct=0; streak=0; locked=false; els.feedback.textContent=''; updatePills(); next();
    }

    function check(){ if(!current) return; const input = els.answer.value||''; const target = els.answer.dataset.target||''; total++; if(isCorrect(input,target)){ correct++; streak++; els.feedback.innerHTML = `<span class='ok'>✓ Correct!</span>`; if(!locked) setTimeout(next,550); else{ locked=false; setTimeout(next,550); } } else { streak=0; els.feedback.innerHTML = `<div class='no'>✗ Not quite.</div><div class='hint'>Answer: ${escapeHtml(target)}</div>`; locked=true; } updatePills(); }
    function idk(){ if(!current) return; total++; streak=0; els.feedback.innerHTML = `<div class='no'>✗ Marked as unknown.</div><div class='hint'>Answer: ${escapeHtml(els.answer.dataset.target||'')}</div>`; locked=true; updatePills(); }
    function showAnswer(){ if(!current) return; els.feedback.innerHTML = `<div class='hint'>Answer: ${escapeHtml(els.answer.dataset.target||'')}</div>`; }
    function stopShowing(){ if(!current) return; locked=false; next(); }
    function skip(){ locked=false; next(); }

    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // --- admin helpers ---
    function populateChapterSelect(){ 
      els.chapterSelect.innerHTML = ''; 
      Object.keys(chapters).sort().forEach(ch=>{ 
        const opt = document.createElement('option'); 
        opt.value=ch; 
        opt.textContent=ch; 
        els.chapterSelect.appendChild(opt); 
      }); 
    }

    function requirePasswordMatches(pw){ 
      const stored = localStorage.getItem(PW_KEY) || btoa('admin'); 
      return btoa(pw) === stored; 
    }

    function addVocabToChapter(chapter, es, en){ 
      if(!chapter) return false; 
      if(!chapters[chapter]) chapters[chapter]=[]; 
      chapters[chapter].push({es:es.trim(), en:en.trim()}); 
      saveChapters(chapters); 
      populateChapterSelect(); 
      return true; 
    }

    function removeChapter(chapter, pw) {
      if (!requirePasswordMatches(pw)) return false;
      if (!chapters[chapter]) return false;
      
      // Ask for confirmation
      if (!confirm(`Are you sure you want to remove "${chapter}" with ${chapters[chapter].length} vocabulary items? This cannot be undone.`)) {
        return false;
      }

      // Remove from initial chapters if it exists there
      if (initialChapters[chapter]) {
        delete initialChapters[chapter];
      }

      // Remove from current chapters
      delete chapters[chapter];
      saveChapters(chapters);
      populateChapterSelect();
      
      // Reset if current chapter was removed
      if (els.chapterSelect.value === '') {
        els.chapterSelect.selectedIndex = 0;
      }
      
      return true;
    }

    function parseQuizletText(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out = [];
      // if tab-separated lines
      if(lines.some(l=>l.includes('\t'))){
        for(const l of lines){ const parts = l.split('\t'); if(parts.length>=2) out.push({es:parts[0].trim(), en:parts[1].trim()}); }
        return out;
      }
      // otherwise assume alternating lines: term, definition
      for(let i=0;i+1<lines.length;i+=2){ out.push({es:lines[i], en:lines[i+1]}); }
      return out;
    }

    // --- GitHub Gist cloud sync helpers ---
    const GIST_ID_KEY = 'svp_gist_id_v1';
    const GITHUB_TOKEN_KEY = 'svp_github_token_v1';

    function getStoredGistId(){ return localStorage.getItem(GIST_ID_KEY) || '' }
    function setStoredGistId(id){ if(id) localStorage.setItem(GIST_ID_KEY, id); else localStorage.removeItem(GIST_ID_KEY); }
    function getStoredGithubToken(){ return localStorage.getItem(GITHUB_TOKEN_KEY) || '' }
    function setStoredGithubToken(t){ if(t) localStorage.setItem(GITHUB_TOKEN_KEY, t); else localStorage.removeItem(GITHUB_TOKEN_KEY); }

    }) } catch(e) { console.error(e); }
    
    async function validateToken(token){
      if(!token) return null;
      
      try{
        // Validate token using GitHub API
        const res = await fetch('https://api.github.com/user', { 
          headers: { 
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': `Bearer ${token}` 
          }
        });
        
        if(!res.ok){ 
          const txt = await res.text();
          if(res.status === 401) {
            throw new Error('Token is invalid or expired');
          } else if(res.status === 403) {
            throw new Error('Token scope may be insufficient (needs gist access)');
          } else {
            throw new Error(`Validation failed: ${res.status} ${res.statusText}`);
          }
        }
        
        const body = await res.json();
        if(!body || !body.login) {
          throw new Error('Invalid response from GitHub API');
        }
        
        // Also verify gist scope
        const scopeRes = await fetch('https://api.github.com/user/gists', {
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if(!scopeRes.ok && scopeRes.status === 403) {
          throw new Error('Token does not have gist access scope');
        }
        
        return body.login;
      }catch(e){ 
        console.error('Token validation error:', e);
        throw e; 
      }
    }

    async function publishToGist(createOnly = false) {
      const pw = els.cloudSyncPassword.value || '';
      if(!requirePasswordMatches(pw)) {
        els.adminMsg.textContent = 'Enter admin password in cloud sync section to publish.';
        return;
      }

      const token = (els.githubToken.value || getStoredGithubToken()).trim();
      const gistId = (els.gistId.value || getStoredGistId()).trim();

      try {
        // Always require token for Gist operations
        if(!token) {
          els.adminMsg.textContent = 'GitHub token is required. Please provide a valid token.';
          return;
        }

        // Validate token first
        els.adminMsg.textContent = 'Validating token...';
        const username = await validateToken(token);
        if(!username) {
          els.adminMsg.textContent = 'Token validation failed. Please check your token.';
          setStoredGithubToken(''); // Clear invalid token
          return;
        }

        els.adminMsg.textContent = `Publishing as ${username}...`;
        const content = JSON.stringify(chapters, null, 2);

        const jsonContent = JSON.stringify(chapters, null, 2);
        
        try {
          let result;
          if(createOnly || !gistId) {
            els.adminMsg.textContent = 'Creating new gist...';
            result = await fetch('https://api.github.com/gists', {
              method: 'POST',
              headers: {
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
                'Authorization': `token ${token}`
              },
              body: JSON.stringify({
                description: 'Spanish Vocab Practice chapters JSON',
                public: true,
                files: {
                  'svp_chapters.json': { content: jsonContent }
                }
              })
            });
          } else {
            els.adminMsg.textContent = 'Updating existing gist...';
            result = await fetch(`https://api.github.com/gists/${gistId}`, {
              method: 'PATCH',
              headers: {
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
                'Authorization': `token ${token}`
              },
              body: JSON.stringify({
                files: {
                  'svp_chapters.json': { content: jsonContent }
                }
              })
            });
          }

          if(!result.ok) {
            const errorText = await result.text();
            let errorMsg;
            
            if(result.status === 401) {
              errorMsg = 'Authentication failed. Token may be invalid.';
              setStoredGithubToken(''); // Clear invalid token
            } else if(result.status === 403) {
              errorMsg = 'Access denied. Token may not have gist permissions.';
              setStoredGithubToken(''); // Clear insufficient token
            } else if(result.status === 404) {
              errorMsg = 'Gist not found. Please check the gist ID.';
            } else if(result.status === 422) {
              errorMsg = 'Invalid request. Please check your data.';
            } else {
              errorMsg = `Gist operation failed (${result.status})`;
            }
            
            els.adminMsg.textContent = errorMsg;
            console.error('Gist API error:', errorText);
            return;
          }

          const responseData = await result.json();
          const newId = responseData.id || gistId;
          setStoredGistId(newId);
          if(token) setStoredGithubToken(token);
          els.gistId.value = newId;
          els.githubToken.value = '';
          els.adminMsg.textContent = `Successfully ${createOnly ? 'created' : 'updated'} gist ${newId}`;
        }
      } catch(e) {
        console.error('Gist operation failed:', e);
        els.adminMsg.textContent = `Error: ${e.message || 'Unknown error'}`;
      }
          const newId = body.id || gistIdInput;
        setStoredGistId(newId);
        if(token) setStoredGithubToken(token);
        els.gistId.value = newId;
        els.githubToken.value = '';
        els.adminMsg.textContent = `Published to Gist ${newId}.`;
      }catch(e){ console.error(e); els.adminMsg.textContent = 'Publish failed (see console).'; }
    }

    async function syncFromGist() {
      const pw = els.cloudSyncPassword.value || '';
      if (!requirePasswordMatches(pw)) {
        els.adminMsg.textContent = 'Enter admin password in cloud sync section to sync.';
        return;
      }

      try {
        const gistId = (els.gistId.value || getStoredGistId()).trim();
        if (!gistId) {
          els.adminMsg.textContent = 'Enter a Gist ID to sync from.';
          return;
        }

        const token = (els.githubToken.value || getStoredGithubToken()).trim();
        els.adminMsg.textContent = 'Fetching gist...';

        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            ...token ? { 'Authorization': `token ${token}` } : {}
          }
        });

        if (!response.ok) {
          let errorMsg = 'Failed to fetch gist';
          if (response.status === 401) {
            errorMsg = 'Authentication failed - token may be invalid';
            setStoredGithubToken('');
          } else if (response.status === 403) {
            if (token) {
              errorMsg = 'Access denied - token may lack permissions';
              setStoredGithubToken('');
            } else {
              errorMsg = 'Rate limit exceeded - try using a token';
            }
          } else if (response.status === 404) {
            errorMsg = 'Gist not found - check the ID';
          }

          const errorText = await response.text();
          console.error('Gist fetch error:', errorText);
          els.adminMsg.textContent = `${errorMsg} (${response.status})`;
          return;
        }
        
        const gistData = await response.json();
        
        if (!gistData.files || !Object.keys(gistData.files).length) {
          els.adminMsg.textContent = 'Error: No files found in gist';
          return;
        }

        // Look for our data file
        const file = gistData.files['svp_chapters.json'] || gistData.files[Object.keys(gistData.files)[0]];
        if (!file || !file.content) {
          els.adminMsg.textContent = 'Error: No content found in gist file';
          return;
        }

        try {
          const parsedData = JSON.parse(file.content);
          if (!parsedData || typeof parsedData !== 'object') {
            throw new Error('Invalid data format');
          }

          // Ask about merge strategy
          const shouldOverwrite = confirm(
            'How would you like to handle the sync?\n\n' +
            'OK = Overwrite local data completely\n' +
            'Cancel = Merge (keep local data and add missing items)'
          );

          if (shouldOverwrite) {
            chapters = parsedData;
          } else {
            chapters = mergeChapters(chapters, parsedData);
          }

          // Save and update UI
          saveChapters(chapters);
          populateChapterSelect();
          
          // Store successful configuration
          setStoredGistId(gistId);
          if (token) setStoredGithubToken(token);
          els.gistId.value = gistId;
          els.githubToken.value = '';

          els.adminMsg.textContent = `Sync completed (${shouldOverwrite ? 'overwritten' : 'merged'})`;

        } catch (parseError) {
          console.error('Failed to parse gist data:', parseError);
          els.adminMsg.textContent = 'Error: Invalid data format in gist';
          return;
        }
      } catch (error) {
        console.error('Sync operation failed:', error);
        els.adminMsg.textContent = `Sync failed: ${error.message || 'Unknown error'}`;
      }
    }

      // --- safe merge-only fetch (no password required) for auto-sync
      async function fetchGistAndMerge(){
        try{
          const gistId = (els.gistId.value || getStoredGistId()).trim();
          if(!gistId) return; // nothing to do
          const res = await fetch(`https://api.github.com/gists/${gistId}`);
          if(!res.ok){ console.warn('Auto-sync fetch failed', res.status); return; }
          const body = await res.json();
          let fileContent = null;
          if(body.files && body.files['svp_chapters.json']) fileContent = body.files['svp_chapters.json'].content;
          else {
            const keys = Object.keys(body.files||{});
            if(keys.length) fileContent = body.files[keys[0]].content;
          }
          if(!fileContent) return;
          const parsed = JSON.parse(fileContent);
          const merged = mergeChapters(chapters, parsed);
          // If merged changed something, persist and update UI
          if(JSON.stringify(merged) !== JSON.stringify(chapters)){
            chapters = merged;
            saveChapters(chapters);
            populateChapterSelect();
            els.adminMsg.textContent = 'Auto-sync: merged remote chapters.';
          }
        }catch(e){ console.warn('Auto-sync error', e); }
      }

      function mergeChapters(local, remote){
        // safe merge: add missing chapters and missing items without duplicating exact es+en pairs
        const out = JSON.parse(JSON.stringify(local));
        for(const ch of Object.keys(remote||{})){
          if(!out[ch]) out[ch] = [];
          const exists = new Set(out[ch].map(x => `${normalizeSegment(x.es)}|${normalizeSegment(x.en)}`));
          for(const item of remote[ch]){
            const key = `${normalizeSegment(item.es)}|${normalizeSegment(item.en)}`;
            if(!exists.has(key)){
              out[ch].push(item);
              exists.add(key);
            }
          }
        }
        return out;
      }

      let _autoSyncTimer = null;
      function startAutoSync(){
        stopAutoSync();
        const interval = Math.max(10, parseInt((els.autoSyncInterval && els.autoSyncInterval.value) || 60, 10));
        _autoSyncTimer = setInterval(fetchGistAndMerge, interval * 1000);
        // run once immediately
        fetchGistAndMerge();
      }
      function stopAutoSync(){ if(_autoSyncTimer){ clearInterval(_autoSyncTimer); _autoSyncTimer = null; } }

    // --- events ---
    els.startBtn.addEventListener('click', start);
    els.checkBtn.addEventListener('click', check);
    els.idkBtn.addEventListener('click', idk);
    els.showBtn.addEventListener('click', showAnswer);
    els.stopBtn.addEventListener('click', stopShowing);
    els.skipBtn.addEventListener('click', skip);

    document.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ if(document.activeElement===els.answer){ e.preventDefault(); check(); } } if(e.key==='ArrowRight'){ if(!locked) next(); } if(e.key==='Escape'){ if(locked) stopShowing(); } });

    els.adminBtn.addEventListener('click', ()=>{ els.adminPanel.classList.add('show'); els.adminPanel.setAttribute('aria-hidden','false'); els.adminMsg.textContent=''; els.adminChapter.value = els.chapterSelect.value || '' });
    els.closeAdmin.addEventListener('click', ()=>{ els.adminPanel.classList.remove('show'); els.adminPanel.setAttribute('aria-hidden','true'); });
    
    // Add remove chapter functionality
    els.removeChapterBtn = document.getElementById('removeChapterBtn');
    els.removeChapterBtn.addEventListener('click', () => {
      const chapter = (els.adminChapter.value || '').trim();
      const pw = els.adminPassword.value || '';
      
      if (!chapter) {
        els.adminMsg.textContent = 'Please enter a chapter name.';
        return;
      }
      
      if (!chapters[chapter]) {
        els.adminMsg.textContent = 'Chapter not found.';
        return;
      }
      
      if (removeChapter(chapter, pw)) {
        els.adminMsg.textContent = `Chapter "${chapter}" removed successfully.`;
        els.adminChapter.value = '';
        els.adminPassword.value = '';
        // auto-publish if enabled
        try{ if(els.autoPublish && els.autoPublish.checked){ const token = els.githubToken.value || getStoredGithubToken(); if(token){ publishToGist(); } } }catch(e){ console.warn('Auto-publish failed', e); }
      } else {
        els.adminMsg.textContent = 'Incorrect password or operation cancelled.';
      }
    });

    els.addVocabBtn.addEventListener('click', ()=>{
      const pw = els.adminPassword.value || '';
      if(!requirePasswordMatches(pw)){ els.adminMsg.textContent = 'Password incorrect.'; return; }
      const ch = (els.adminChapter.value || '').trim(); const es = (els.adminEs.value || '').trim(); const en = (els.adminEn.value || '').trim();
      if(!ch || !es || !en){ els.adminMsg.textContent = 'Fill chapter, Spanish and English.'; return; }
      addVocabToChapter(ch, es, en);
      els.adminMsg.textContent = `Added to ${ch}.`;
      els.adminEs.value=''; els.adminEn.value=''; saveChapters(chapters);
      // auto-publish if enabled and token present
      try{
        if(els.autoPublish && els.autoPublish.checked){ const token = els.githubToken.value || getStoredGithubToken(); if(token){ publishToGist(); } }
      }catch(e){ console.warn('Auto-publish failed', e); }
    });

    els.importQuizletBtn.addEventListener('click', ()=>{
      const pw = els.quizletPassword.value || '';
      if(!requirePasswordMatches(pw)){ els.adminMsg.textContent = 'Password incorrect.'; return; }
      const ch = (els.adminChapter.value || '').trim(); if(!ch){ els.adminMsg.textContent='Enter chapter name.'; return; }
      const parsed = parseQuizletText(els.quizletText.value || ''); if(parsed.length===0){ els.adminMsg.textContent='No valid pairs found.'; return; }
      if(!chapters[ch]) chapters[ch]=[];
      for(const p of parsed){ chapters[ch].push({es:p.es, en:p.en}); }
      saveChapters(chapters); populateChapterSelect(); els.adminMsg.textContent = `Imported ${parsed.length} items into ${ch}.`;
      els.quizletText.value='';
      // auto-publish if enabled and token present
      try{
        if(els.autoPublish && els.autoPublish.checked){ const token = els.githubToken.value || getStoredGithubToken(); if(token){ publishToGist(); } }
      }catch(e){ console.warn('Auto-publish failed', e); }
    });

    // publish/sync buttons
    els.publishGistBtn = document.getElementById('publishGistBtn');
    els.syncGistBtn = document.getElementById('syncGistBtn');
    els.gistId = document.getElementById('gistId');
    els.githubToken = document.getElementById('githubToken');

    els.publishGistBtn.addEventListener('click', async ()=>{
      els.adminMsg.textContent = 'Publishing...';
      await publishToGist(false);
    });

    els.createGistBtn.addEventListener('click', async ()=>{
      els.adminMsg.textContent = 'Creating gist...';
      await publishToGist(true);
    });

    els.syncGistBtn.addEventListener('click', async ()=>{
      els.adminMsg.textContent = 'Syncing...';
      await syncFromGist();
    });

    // auto-sync toggle handler
    els.autoSync = document.getElementById('autoSync');
    els.autoSyncInterval = document.getElementById('autoSyncInterval');
    els.autoPublish = document.getElementById('autoPublish');
    // initialize from stored gist id or default
    const storedId = getStoredGistId();
    if(storedId) {
      els.gistId.value = storedId;
    } else {
      els.gistId.value = DEFAULT_GIST_ID;
      setStoredGistId(DEFAULT_GIST_ID);
    }
    if(getStoredGithubToken()) els.githubToken.value = ''; // don't prefill token field for safety
    
    // Enable auto-sync by default
    els.autoSync.checked = true;
    startAutoSync();

    // start auto sync if enabled by default
    els.autoSync.addEventListener('change', ()=>{
      if(els.autoSync.checked) startAutoSync(); else stopAutoSync();
    });

    // stop timer on page unload
    window.addEventListener('beforeunload', ()=>{ stopAutoSync(); });

    els.changePasswordBtn.addEventListener('click', ()=>{
      const cur = (els.curPassword.value||''); const nw = (els.newPassword.value||'');
      if(!requirePasswordMatches(cur)){ els.adminMsg.textContent='Current password incorrect.'; return; }
      if(!nw){ els.adminMsg.textContent='Enter a new password.'; return; }
      localStorage.setItem(PW_KEY, btoa(nw)); els.adminMsg.textContent='Password changed.'; els.curPassword.value=''; els.newPassword.value='';
    });

    // --- init ---
    populateChapterSelect();
    updatePills();
    
    // Force reset the password to ensure it's set correctly
    localStorage.setItem(PW_KEY, btoa('01062010D@nesh'));

  </script>
</body>
</html>
